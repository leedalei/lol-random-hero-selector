name: ğŸš€ Deploy to Production Server

on:
  push:
    branches: [ main, deploy ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # æ„å»ºå’Œæµ‹è¯•å‰ç«¯
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: npm ci

      - name: âœ… è¿è¡Œç±»å‹æ£€æŸ¥
        run: npm run build

      - name: ğŸ—ï¸ æ„å»ºå‰ç«¯
        run: npm run build

      - name: ğŸ“¦ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1

      - name: ğŸ“¦ ä¸Šä¼ åç«¯ä»£ç 
        uses: actions/upload-artifact@v4
        with:
          name: server
          path: server/
          retention-days: 1

  # éƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: success() # åªæœ‰æ„å»ºæˆåŠŸæ‰éƒ¨ç½²

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4

      - name: ğŸ” å‡†å¤‡SSHå¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸš€ éƒ¨ç½²åˆ°æœåŠ¡å™¨
        run: |
          echo "ğŸŒ å¼€å§‹éƒ¨ç½²åˆ°æœåŠ¡å™¨..."
          echo "æœåŠ¡å™¨åœ°å€: ${{ secrets.SERVER_HOST }}"
          echo "éƒ¨ç½²è·¯å¾„: ${{ secrets.DEPLOY_PATH }}"

          # åˆ›å»ºå¤‡ä»½ç›®å½•
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            mkdir -p ${{ secrets.DEPLOY_PATH }}/backups
            mkdir -p ${{ secrets.DEPLOY_PATH }}/logs
          "

          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            if [ -d '${{ secrets.DEPLOY_PATH }}/dist' ]; then
              cp -r ${{ secrets.DEPLOY_PATH }}/dist ${{ secrets.DEPLOY_PATH }}/backups/dist-$(date +%Y%m%d-%H%M%S)
            fi
            if [ -d '${{ secrets.DEPLOY_PATH }}/server' ]; then
              cp -r ${{ secrets.DEPLOY_PATH }}/server ${{ secrets.DEPLOY_PATH }}/backups/server-$(date +%Y%m%d-%H%M%S)
            fi
          "

          # åŒæ­¥æ–‡ä»¶åˆ°æœåŠ¡å™¨
          rsync -avz --delete \
            dist/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/dist/

          rsync -avz --delete \
            server/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/server/

          # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²è„šæœ¬
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}

            # å®‰è£…åç«¯ä¾èµ–
            cd server
            npm ci --production

            # åœæ­¢æ—§æœåŠ¡
            if pgrep -f 'node.*index.js' > /dev/null; then
              pkill -f 'node.*index.js'
              echo 'å·²åœæ­¢æ—§æœåŠ¡'
              sleep 3
            fi

            # å¯åŠ¨æ–°æœåŠ¡
            cd ..
            nohup npm run start:server > logs/server.log 2>&1 &
            echo $! > server.pid

            echo 'âœ… åç«¯æœåŠ¡å¯åŠ¨å®Œæˆ'

            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            sleep 5
            if curl -s http://localhost:3010/health > /dev/null; then
              echo 'âœ… åç«¯æœåŠ¡è¿è¡Œæ­£å¸¸'
            else
              echo 'âŒ åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥'
              exit 1
            fi
          "

      - name: ğŸ‰ éƒ¨ç½²æˆåŠŸé€šçŸ¥
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ å‰ç«¯åœ°å€: https://${{ secrets.SERVER_DOMAIN }}"
          echo "ğŸ”§ åç«¯åœ°å€: https://${{ secrets.SERVER_DOMAIN }}/health"
          echo "ğŸ“Š æŸ¥çœ‹æ—¥å¿—: ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'tail -f ${{ secrets.DEPLOY_PATH }}/logs/server.log'"

  # å¥åº·æ£€æŸ¥
  health-check:
    needs: deploy
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: ğŸ¥ å¥åº·æ£€æŸ¥
        run: |
          echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."

          # æ£€æŸ¥å‰ç«¯
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${{ secrets.SERVER_DOMAIN }})
          if [ "$FRONTEND_STATUS" = "200" ]; then
            echo "âœ… å‰ç«¯å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ å‰ç«¯å¥åº·æ£€æŸ¥å¤±è´¥ (çŠ¶æ€ç : $FRONTEND_STATUS)"
            exit 1
          fi

          # æ£€æŸ¥åç«¯
          BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${{ secrets.SERVER_DOMAIN }}/health)
          if [ "$BACKEND_STATUS" = "200" ]; then
            echo "âœ… åç«¯å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ åç«¯å¥åº·æ£€æŸ¥å¤±è´¥ (çŠ¶æ€ç : $BACKEND_STATUS)"
            exit 1
          fi

          echo "ğŸ‰ æ‰€æœ‰æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡ï¼"

  # å›æ»šä½œä¸š (å¯é€‰)
  rollback:
    runs-on: ubuntu-latest
    if: failure() && needs.deploy.result == 'failure'
    needs: deploy

    steps:
      - name: ğŸ” å‡†å¤‡SSHå¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ”„ å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
        run: |
          echo "ğŸ”„ æ‰§è¡Œå›æ»šæ“ä½œ..."

          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}

            # æ¢å¤æœ€æ–°å¤‡ä»½
            LATEST_BACKUP=\$(ls -t backups/ | head -1)
            echo "å›æ»šåˆ°: \$LATEST_BACKUP"

            case \$LATEST_BACKUP in
              dist-*)
                rm -rf dist
                tar -xzf "backups/\$LATEST_BACKUP.tar.gz" 2>/dev/null || \
                cp -r "backups/\$LATEST_BACKUP" dist/ 2>/dev/null || \
                echo "å›æ»šdistå¤±è´¥"
                ;;
              server-*)
                rm -rf server
                cp -r "backups/\$LATEST_BACKUP" server/ 2>/dev/null || \
                echo "å›æ»šserverå¤±è´¥"
                ;;
            esac

            # é‡å¯æœåŠ¡
            if pgrep -f 'node.*index.js' > /dev/null; then
              pkill -f 'node.*index.js'
              sleep 3
            fi

            cd server
            npm ci --production
            cd ..
            nohup npm run start:server > logs/server.log 2>&1 &
            echo $! > server.pid

            echo 'âœ… å›æ»šå®Œæˆ'
          "